# Migration Guide - TrustLink v1.0 to v2.0

This guide helps you migrate from the original TrustLink implementation to the improved version with all new features.

## üìã Overview of Changes

### Contract Changes
- **TrustLinkCore**: New functions and Proof struct fields
- **ProofVerifier**: View-only functions added
- **TrustLinkRegistry**: Fixed visibility toggling logic

### Frontend Changes
- New components for enhanced UX
- Localization support
- Updated contract ABIs
- New utility functions

---

## üîÑ Smart Contract Migration

### Step 1: Update Proof Struct References

**Old Proof Struct**:
```solidity
struct Proof {
    uint256 agreementId;
    bytes32 documentHash;
    uint256 timestamp;
    address submittedBy;
}
```

**New Proof Struct**:
```solidity
struct Proof {
    uint256 agreementId;
    bytes32 documentHash;
    uint256 timestamp;
    address submittedBy;
    bool requiresBilateralAck;      // NEW
    bool acknowledgedByPartner;     // NEW
    bool isRevoked;                  // NEW
}
```

**Action Required**: If you were reading proofs directly via `proofs()` mapping, update tuple destructuring.

### Step 2: Deploy New Contracts

```bash
# Clean previous artifacts
npm run clean

# Compile new contracts
npm run compile

# Deploy to testnet
npm run deploy

# Addresses will auto-inject to frontend/.env
```

### Step 3: Update Interface References

If you were using `ITrustLinkCore` in external contracts:

```solidity
// Update interface import
import "./interfaces/ITrustLinkCore.sol";

// Proof struct now has 3 additional fields
```

---

## üé® Frontend Migration

### Step 1: Update Dependencies

```bash
cd frontend
npm install
# This will install qr-code-styling and other new deps
```

### Step 2: Update Contract Addresses

Old `.env`:
```env
VITE_TRUSTLINK_CORE=0x...
```

New `.env` (auto-generated by deploy script):
```env
VITE_TRUSTLINK_CORE_ADDRESS=0x...
VITE_TRUSTLINK_REGISTRY_ADDRESS=0x...
VITE_PROOF_VERIFIER_ADDRESS=0x...
```

### Step 3: Update Contract Imports

**Old**:
```javascript
import { verifyProof } from '../utils/contract'

const result = await verifyProof(contract, documentHash)
const [exists, timestamp, agreementId, submittedBy] = result
```

**New**:
```javascript
import { verifyProof, getProof } from '../utils/contract'

// Simple verification (returns tuple)
const [exists, timestamp, agreementId, submittedBy] = 
  await verifyProof(contract, documentHash)

// Full proof details (returns struct)
const proof = await getProof(contract, documentHash)
console.log(proof.isRevoked, proof.requiresBilateralAck)
```

### Step 4: Add New Components

Import new components into your pages:

```javascript
// Verification page
import VerificationResult from '../components/VerificationResult'
import ProofTimeline from '../components/ProofTimeline'
import QRShareButton from '../components/QRShareButton'

// Navigation
import LanguageSwitcher from '../components/LanguageSwitcher'
```

### Step 5: Update File Hashing

**Old**:
```javascript
import { hashFile } from '../utils/hashFile'

const hash = await hashFile(file)
```

**New (with progress)**:
```javascript
import { hashFile, validateFile, generateSaltedHash } from '../utils/hashFile'
import { SUPPORTED_FILE_MIME_TYPES, MAX_FILE_SIZE_MB } from '../utils/constants'

// Validate first
const validation = validateFile(file, SUPPORTED_FILE_MIME_TYPES, MAX_FILE_SIZE_MB)
if (!validation.valid) {
  alert(validation.error)
  return
}

// Hash with progress
const hash = await hashFile(file, (progress) => {
  console.log(`Hashing: ${progress}%`)
})

// Optional: Generate salted hash
const saltedHash = generateSaltedHash(hash, agreementId)
```

---

## üÜï Using New Features

### Bilateral Acknowledgement

```javascript
import { recordProofWithAck, acknowledgeProof } from '../utils/contract'

// User A records proof requiring ack
await recordProofWithAck(contract, agreementId, documentHash, signer)

// User B acknowledges
await acknowledgeProof(contract, documentHash, signerB)

// Check status
const proof = await getProof(contract, documentHash)
console.log('Acknowledged:', proof.acknowledgedByPartner)
```

### Proof Revocation

```javascript
import { proposeRevocation, revokeProof } from '../utils/contract'

// Propose revocation (emits event)
await proposeRevocation(contract, documentHash, signer)

// Revoke proof
await revokeProof(contract, documentHash, signer)

// Verify revoked status
const proof = await getProof(contract, documentHash)
console.log('Is revoked:', proof.isRevoked)
```

### Public/Private Proofs

```javascript
// Connect to registry
const registryAddress = CONTRACT_ADDRESSES.trustLinkRegistry
const registryAbi = [
  "function setProofVisibility(bytes32 documentHash, bool isPublic) external",
  "function verifyPublicProof(bytes32) external view returns (bool, uint256, uint256, address)",
  "function getUserPublicProofs(address) external view returns (bytes32[])"
]
const registry = new ethers.Contract(registryAddress, registryAbi, signer)

// Make proof public
await registry.setProofVisibility(documentHash, true)

// Toggle back to private
await registry.setProofVisibility(documentHash, false)

// Check public proofs for an address
const publicProofs = await registry.getUserPublicProofs(userAddress)
```

### Localization

```javascript
import { t, getCurrentLanguage, setCurrentLanguage, LANGUAGES } from '../utils/localization'

// Get current language
const currentLang = getCurrentLanguage() // 'en' or 'sw'

// Translate text
const title = t('landing.hero.title', currentLang)

// Change language
setCurrentLanguage(LANGUAGES.SW) // Switch to Swahili
```

### Batch Verification

Navigate to `/batch-verify` or use the utility:

```javascript
const hashes = [
  '0x1234...',
  '0x5678...',
  '0xabcd...'
]

const results = await Promise.all(
  hashes.map(hash => verifyProof(contract, hash))
)

results.forEach((result, i) => {
  console.log(`Hash ${i}: ${result[0] ? 'Verified' : 'Not Found'}`)
})
```

---

## ‚öôÔ∏è Configuration Updates

### hardhat.config.js

No changes required - existing config works with new contracts.

### vite.config.js

No changes required.

### tailwind.config.js

Add new component styles if using custom theme:

```javascript
module.exports = {
  content: [
    "./src/**/*.{js,jsx,ts,tsx}",
  ],
  theme: {
    extend: {
      colors: {
        'trust-blue': '#3A8DFF',
        'trust-navy': '#1E293B',
        // ... your custom colors
      }
    }
  }
}
```

---

## üß™ Testing Migration

### Run Updated Tests

```bash
# Run all tests including new ones
npm test

# Run specific test suites
npx hardhat test test/TrustLinkCore.advanced.test.js
npx hardhat test test/TrustLinkRegistry.test.js

# Coverage
npm run test:coverage
```

### Test New Features Manually

1. **Bilateral Ack Flow**:
   - Create agreement between two accounts
   - Record proof with ack requirement
   - Partner acknowledges
   - Verify `acknowledgedByPartner = true`

2. **Revocation Flow**:
   - Record a proof
   - Propose revocation
   - Revoke proof
   - Verify `isRevoked = true`

3. **Public Registry**:
   - Record a proof
   - Set visibility to public
   - Navigate to `/public-registry`
   - Search for your address
   - Confirm proof appears

4. **Batch Verify**:
   - Navigate to `/batch-verify`
   - Paste 3-5 known hashes
   - Click verify
   - Export CSV

5. **Language Toggle**:
   - Click Globe icon
   - Select Kiswahili
   - Verify UI text changes
   - Switch back to English

---

## üö® Breaking Changes

### 1. Proof Struct Fields

**Impact**: If you were destructuring proof tuples with exact positions.

**Fix**:
```javascript
// Old (4 fields)
const [agreementId, documentHash, timestamp, submittedBy] = await contract.proofs(hash)

// New (7 fields)
const [agreementId, documentHash, timestamp, submittedBy, requiresBilateralAck, acknowledgedByPartner, isRevoked] = 
  await contract.proofs(hash)

// Better: Use getProof()
const proof = await contract.getProof(hash)
```

### 2. Contract Address Env Vars

**Impact**: Environment variable names changed.

**Fix**: Update all references from `VITE_TRUSTLINK_CORE` to `VITE_TRUSTLINK_CORE_ADDRESS`.

### 3. TrustLinkRegistry Constructor

**Impact**: Now requires `TrustLinkCore` address.

**Fix**: Already handled in deployment script - no action needed.

---

## üìä Performance Improvements

### Gas Optimization

| Operation | Old Gas | New Gas | Savings |
|-----------|---------|---------|---------|
| `verifyProof` (view) | 0 | 0 | - |
| `recordProof` | ~85k | ~95k | -10k* |
| `setProofVisibility` | ~60k | ~55k | +5k |

*Additional 10k gas for bilateral ack fields is optional feature.

### Frontend Performance

- File hashing now shows progress (better UX)
- Batch operations reduce RPC calls
- View-only functions eliminate unnecessary transactions

---

## üîí Security Considerations

### New Security Features

1. **Salted Hashing** - Prevents rainbow table attacks
2. **Bilateral Ack** - Prevents unilateral claims
3. **Revocation** - Dispute resolution mechanism
4. **Agreement Cancellation** - Proper lifecycle management

### Audit Recommendations

Before mainnet deployment:
1. Full security audit of new functions
2. Verify revocation logic cannot be abused
3. Test bilateral ack edge cases
4. Confirm registry de-duplication works in all scenarios

---

## üíæ Data Migration

### No On-Chain Migration Needed

Existing proofs are **not affected** by new fields - they default to:
- `requiresBilateralAck = false`
- `acknowledgedByPartner = false`
- `isRevoked = false`

### Historical Data

Old proofs remain verifiable with new contracts. No data loss.

---

## üìû Support

### Issues?

1. Check `IMPROVEMENTS.md` for detailed feature docs
2. Review test files for usage examples
3. Open GitHub issue with error logs
4. Join hackathon Telegram for live help

### Rollback

If you need to revert:
```bash
git checkout v1.0  # Original version
npm run deploy
```

---

## ‚úÖ Migration Checklist

- [ ] Read this guide completely
- [ ] Backup existing `.env` files
- [ ] Run `npm run clean && npm run compile`
- [ ] Deploy new contracts: `npm run deploy`
- [ ] Verify addresses in `frontend/.env`
- [ ] Update frontend dependencies: `cd frontend && npm install`
- [ ] Update contract imports in your code
- [ ] Test new features locally
- [ ] Run full test suite: `npm test`
- [ ] Update any external integrations
- [ ] Deploy frontend: `npm run build`
- [ ] Announce migration to users

---

## üéØ Next Steps After Migration

1. **Integrate New Components**:
   - Add `VerificationResult` to your verify page
   - Add `ProofTimeline` to proof details
   - Add `QRShareButton` for sharing
   - Add `LanguageSwitcher` to navigation

2. **Enable Optional Features**:
   - Create `/batch-verify` route
   - Create `/public-registry` route
   - Add bilateral ack toggle to record proof form
   - Add salted hash option

3. **Customize Translations**:
   - Review Swahili translations in `localization.js`
   - Add more language-specific microcopy
   - Consider adding more languages

4. **Monitor & Optimize**:
   - Set up event listeners for new events
   - Track usage of bilateral ack feature
   - Monitor registry visibility toggles
   - Collect UX feedback

---

**Migration Complete! üéâ**

Your TrustLink instance now has all security, UX, and functionality improvements for the ETH Safari Hackathon.

For questions, contact: eduedwyn5@gmail.com
